<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.bapai.group.dao.GroupDao">

    <insert id="insertGroup" useGeneratedKeys="true" keyProperty="groupId">
        INSERT INTO `groups` (owner_id, name, description, max_member, type, created_at)
        VALUES (#{ownerId}, #{name}, #{description}, #{maxMember}, #{type}, NOW())
    </insert>

    <insert id="insertGroupMember">
        INSERT INTO group_member (group_id, user_id, role, joined_at)
        VALUES (#{groupId}, #{userId}, #{role}, NOW())
    </insert>

    <select id="selectGroupList" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT t.group_id, t.owner_id, t.name, t.description, t.max_member, t.type, t.created_at,
        m.nickname AS ownerName,
        (SELECT COUNT(*) FROM group_member gm WHERE gm.group_id = t.group_id) AS memberCount
        FROM `groups` t
        JOIN member m ON t.owner_id = m.user_id
        WHERE 1=1
        <if test="keywordList != null and !keywordList.isEmpty()">
            AND t.group_id IN (
            SELECT gh.group_id
            FROM group_hashtags gh
            JOIN hashtags h ON gh.tag_id = h.tag_id
            WHERE h.name IN
            <foreach collection="keywordList" item="kw" open="(" separator="," close=")">
                #{kw}
            </foreach>
            GROUP BY gh.group_id
            HAVING COUNT(DISTINCT h.name) = ${keywordList.size}
            )
        </if>
        ORDER BY t.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <insert id="insertInvite">
        INSERT INTO group_member (group_id, user_id, role, joined_at)
        VALUES (#{groupId}, #{userId}, 'MEMBER', NOW())
    </insert>

    <select id="selectGroupDetail" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT t.group_id,
               t.owner_id,
               t.name,
               t.description,
               t.max_member,
               t.type,
               t.created_at,
               m.nickname                                                            AS ownerName,
               (SELECT COUNT(*) FROM group_member gm WHERE gm.group_id = t.group_id) AS memberCount
        FROM `groups` t
                 JOIN member m ON t.owner_id = m.user_id
        WHERE t.group_id = #{groupId}
    </select>

    <delete id="deleteGroupMember">
        DELETE
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </delete>

    <select id="checkJoined" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </select>

    <select id="countMembers" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE group_id = #{groupId}
    </select>

    <select id="selectMyRole" resultType="string">
        SELECT role
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </select>

    <update id="updateGroupOwner">
        UPDATE `groups`
        SET owner_id = #{newOwnerId}
        WHERE group_id = #{groupId}
    </update>

    <update id="updateMemberRole">
        UPDATE group_member
        SET role = #{role}
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </update>

    <select id="selectGroupRanking" resultType="com.ssafy.bapai.group.dto.GroupRankDto">
        SELECT m.user_id, m.nickname, IFNULL(SUM(r.score), 0) as totalScore, COUNT(r.report_id) as reportCount
        FROM group_member gm
                 JOIN member m ON gm.user_id = m.user_id
                 LEFT JOIN report r ON m.user_id = r.user_id
        WHERE gm.group_id = #{groupId}
        GROUP BY m.user_id
        ORDER BY totalScore DESC
        LIMIT #{limit}
    </select>

    <insert id="insertGroupHashtag">
        INSERT INTO group_hashtags (group_id, tag_id)
        VALUES (#{groupId}, #{tagId})
    </insert>

    <select id="selectGroupTags" resultType="string">
        SELECT h.name
        FROM group_hashtags gh
                 JOIN hashtags h ON gh.tag_id = h.tag_id
        WHERE gh.group_id = #{groupId}
    </select>

    <select id="selectTagIdByName" resultType="long">
        SELECT tag_id
        FROM hashtags
        WHERE name = #{tagName}
    </select>

    <select id="selectHashtagList" resultType="string">
        SELECT name
        FROM hashtags
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY name ASC
    </select>

    <insert id="insertHashtag" useGeneratedKeys="true" keyProperty="tagId" parameterType="map">
        INSERT INTO hashtags (name)
        VALUES (#{name})
    </insert>

    <select id="selectMyGroups" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT g.group_id,
               g.owner_id,
               g.name,
               g.description,
               g.img_url,
               g.max_member,
               g.type,
               g.created_at,
               (SELECT COUNT(*) FROM group_member WHERE group_id = g.group_id) as memberCount
        FROM `groups` g
                 JOIN group_member gm ON g.group_id = gm.group_id
        WHERE gm.user_id = #{userId}
    </select>
</mapper>