<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.bapai.group.dao.GroupDao">

    <insert id="insertGroup" useGeneratedKeys="true" keyProperty="groupId">
        INSERT INTO `groups` (owner_id, name, description, max_member, type, created_at)
        VALUES (#{ownerId}, #{name}, #{description}, #{maxMember}, #{type}, NOW())
    </insert>

    <insert id="insertGroupMember">
        INSERT INTO group_member (group_id, user_id, role, joined_at)
        VALUES (#{groupId}, #{userId}, #{role}, NOW())
    </insert>

    <select id="selectGroupList" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT t.group_id, t.owner_id, t.name, t.description, t.img_url, t.max_member, t.type, t.created_at,
        m.nickname AS ownerName,
        (SELECT COUNT(*) FROM group_member gm WHERE gm.group_id = t.group_id AND gm.role != 'WAIT') AS memberCount
        FROM `groups` t
        JOIN member m ON t.owner_id = m.user_id
        WHERE 1=1
        <if test="keywordList != null and !keywordList.isEmpty()">
            AND (
            <foreach collection="keywordList" item="kw" separator=" OR ">
                t.name LIKE CONCAT('%', #{kw}, '%')
            </foreach>
            OR
            t.group_id IN (
            SELECT gh.group_id
            FROM group_hashtags gh
            JOIN hashtags h ON gh.tag_id = h.tag_id
            WHERE h.name IN
            <foreach collection="keywordList" item="kw" open="(" separator="," close=")">
                #{kw}
            </foreach>
            GROUP BY gh.group_id
            HAVING COUNT(DISTINCT h.name) = #{keywordListSize}
            )
            )
        </if>
        ORDER BY t.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>


    <select id="countAllGroups" resultType="long">
        SELECT COUNT(*)
        FROM `groups` t
        WHERE 1=1
        <if test="keywordList != null and !keywordList.isEmpty()">
            AND (
            <foreach collection="keywordList" item="kw" separator=" OR ">
                t.name LIKE CONCAT('%', #{kw}, '%')
            </foreach>
            OR
            t.group_id IN (
            SELECT gh.group_id
            FROM group_hashtags gh
            JOIN hashtags h ON gh.tag_id = h.tag_id
            WHERE h.name IN
            <foreach collection="keywordList" item="kw" open="(" separator="," close=")">#{kw}</foreach>
            GROUP BY gh.group_id
            HAVING COUNT(DISTINCT h.name) = #{keywordListSize}
            )
            )
        </if>
    </select>
    <insert id="insertInvite">
        INSERT INTO group_member (group_id, user_id, role, joined_at)
        VALUES (#{groupId}, #{userId}, 'MEMBER', NOW())
    </insert>

    <select id="selectGroupDetail" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT t.group_id,
               t.owner_id,
               t.name,
               t.description,
               t.max_member,
               t.`type`,
               t.created_at,
               m.nickname                AS ownerName,
               (SELECT COUNT(*)
                FROM group_member gm
                WHERE gm.group_id = t.group_id
                  AND gm.role != 'WAIT') AS memberCount
        FROM `groups` t
                 JOIN member m ON t.owner_id = m.user_id
        WHERE t.group_id = #{groupId}
    </select>

    <delete id="deleteGroupMember">
        DELETE
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </delete>

    <select id="checkJoined" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </select>

    <select id="countMembers" resultType="int">
        SELECT COUNT(*)
        FROM group_member
        WHERE group_id = #{groupId}
          AND role != 'WAIT'   </select>

    <select id="selectMyRole" resultType="string">
        SELECT role
        FROM group_member
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </select>

    <update id="updateGroupOwner">
        UPDATE `groups`
        SET owner_id = #{newOwnerId}
        WHERE group_id = #{groupId}
    </update>

    <update id="updateMemberRole">
        UPDATE group_member
        SET role = #{role}
        WHERE group_id = #{groupId}
          AND user_id = #{userId}
    </update>

    <select id="selectGroupRankingByDiet" resultType="com.ssafy.bapai.group.dto.GroupRankDto">
        SELECT
        m.user_id AS userId,
        m.nickname,
        m.profile_img AS profileImg,
        IFNULL(SUM(d.score), 0) AS totalScore,
        COUNT(d.diet_id) AS dietCount
        FROM group_member gm
        JOIN member m ON gm.user_id = m.user_id
        LEFT JOIN diet d ON m.user_id = d.user_id
        WHERE gm.group_id = #{groupId}
        AND gm.role != 'WAIT'
        <choose>
            <when test="period == 'daily'">
                AND d.eat_date = CURDATE()
            </when>
            <when test="period == 'weekly'">
                AND d.eat_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 7 DAY) AND CURDATE()
            </when>
            <when test="period == 'monthly'">
                AND d.eat_date LIKE CONCAT(#{currentMonth}, '%')
            </when>
        </choose>
        GROUP BY m.user_id
        ORDER BY totalScore DESC
        LIMIT #{limit}
    </select>
    <insert id="insertGroupHashtag">
        INSERT INTO group_hashtags (group_id, tag_id)
        VALUES (#{groupId}, #{tagId})
    </insert>

    <select id="selectGroupTags" resultType="string">
        SELECT h.name
        FROM group_hashtags gh
                 JOIN hashtags h ON gh.tag_id = h.tag_id
        WHERE gh.group_id = #{groupId}
    </select>

    <select id="selectTagIdByName" resultType="long">
        SELECT tag_id
        FROM hashtags
        WHERE name = #{tagName}
    </select>

    <select id="selectHashtagList" resultType="string">
        SELECT name
        FROM hashtags
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND name LIKE CONCAT('%', #{keyword}, '%')
        </if>
        ORDER BY name ASC
    </select>

    <insert id="insertHashtag" useGeneratedKeys="true" keyProperty="tagId" parameterType="map">
        INSERT INTO hashtags (name)
        VALUES (#{name})
    </insert>

    <select id="selectMyGroupsPaged" resultType="com.ssafy.bapai.group.dto.GroupDto">
        SELECT g.group_id,
               g.owner_id,
               g.name,
               g.description,
               g.img_url,
               g.max_member,
               g.type,
               g.created_at,
               (SELECT COUNT(*) FROM group_member WHERE group_id = g.group_id AND role != 'WAIT') as memberCount
        FROM `groups` g
                 JOIN group_member gm ON g.group_id = gm.group_id
        WHERE gm.user_id = #{userId}
        ORDER BY g.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!--!! 추가: 내 그룹 전체 개수 -->
    <select id="countMyGroups" resultType="long">
        SELECT COUNT(*)
        FROM group_member
        WHERE user_id = #{userId}
    </select>

    <select id="selectGroupMembers" resultType="com.ssafy.bapai.member.dto.MemberDto">
        SELECT m.user_id as userId,
               m.nickname,
               gm.role
        FROM group_member gm
                 JOIN member m ON gm.user_id = m.user_id
        WHERE gm.group_id = #{groupId}
          AND gm.role != 'WAIT'
    </select>

    <select id="searchUsersByNickname" resultType="com.ssafy.bapai.member.dto.MemberDto">
        SELECT user_id as userId, nickname
        FROM member
        WHERE nickname LIKE CONCAT('%', #{nickname}, '%')
          AND user_id NOT IN (
            SELECT user_id FROM group_member WHERE group_id = #{groupId}
            )
        LIMIT 10
    </select>

    <update id="updateGroup" parameterType="com.ssafy.bapai.group.dto.GroupDto">
        UPDATE `groups`
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="imgUrl != null">img_url = #{imgUrl},</if>
            <if test="maxMember != null">max_member = #{maxMember},</if>
            <if test="type != null and type != ''">type = #{type},</if>
        </set>
        WHERE group_id = #{groupId}
    </update>


    <select id="selectPendingMembers" resultType="com.ssafy.bapai.member.dto.MemberDto">
        SELECT m.*
        FROM group_member gm
                 JOIN member m ON gm.user_id = m.user_id
        WHERE gm.group_id = #{groupId}
          AND gm.role = 'WAIT'
    </select>

    <delete id="deleteAllGroupHashtags" parameterType="long">
        DELETE
        FROM group_hashtags
        WHERE group_id = #{groupId}
    </delete>


    <delete id="deleteAllGroupMembers" parameterType="long">
        DELETE
        FROM group_member
        WHERE group_id = #{groupId}
    </delete>

    <delete id="deleteGroup" parameterType="long">
        DELETE
        FROM `groups`
        WHERE group_id = #{groupId}
    </delete>
</mapper>