<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.bapai.diet.dao.DietDao">

    <resultMap id="DietResultMap" type="com.ssafy.bapai.diet.dto.DietDto">
        <id property="dietId" column="diet_id"/>
        <result property="userId" column="user_id"/>
        <result property="eatDate" column="eat_date"/>

        <result property="time" column="eat_time"/>

        <result property="mealType" column="meal_type"/>
        <result property="dietImg" column="diet_img"/>
        <result property="memo" column="memo"/>

        <result property="totalKcal" column="total_kcal"/>
        <result property="totalCarbs" column="total_carbs"/>
        <result property="totalProtein" column="total_protein"/>
        <result property="totalFat" column="total_fat"/>

        <result property="score" column="score"/>
        <result property="aiAnalysis" column="ai_analysis"/>

        <collection property="foodList" ofType="com.ssafy.bapai.diet.dto.DietDetailDto">
            <id property="detailId" column="detail_id"/>
            <result property="dietId" column="diet_id"/>
            <result property="foodCode" column="food_code"/>
            <result property="foodName" column="food_name"/>
            <result property="amount" column="amount"/>
            <result property="kcal" column="kcal"/>
            <result property="carbs" column="carbs"/>
            <result property="protein" column="protein"/>
            <result property="fat" column="fat"/>
        </collection>
    </resultMap>

    <insert id="insertDiet" useGeneratedKeys="true" keyProperty="dietId"
            parameterType="com.ssafy.bapai.diet.dto.DietDto">
        INSERT INTO diet (user_id, eat_date, eat_time, meal_type, diet_img, memo,
                          total_kcal, total_carbs, total_protein, total_fat,
                          score, ai_analysis, created_at)
        VALUES (#{userId}, #{eatDate}, #{time}, #{mealType}, #{dietImg}, #{memo},
                #{totalKcal}, #{totalCarbs}, #{totalProtein}, #{totalFat},
                #{score}, #{aiAnalysis}, NOW())
    </insert>

    <insert id="insertDietDetails" parameterType="java.util.List">
        INSERT INTO diet_detail (diet_id, food_code, food_name, amount, kcal, carbs, protein, fat)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.dietId}, #{item.foodCode}, #{item.foodName}, #{item.amount},
            #{item.kcal}, #{item.carbs}, #{item.protein}, #{item.fat})
        </foreach>
    </insert>

    <insert id="insertDietDetail" parameterType="com.ssafy.bapai.diet.dto.DietDetailDto">
        INSERT INTO diet_detail (diet_id, food_code, food_name, amount, kcal, carbs, protein, fat)
        VALUES (#{dietId}, #{foodCode}, #{foodName}, #{amount}, #{kcal}, #{carbs}, #{protein}, #{fat})
    </insert>

    <select id="selectDailyDiets" resultMap="DietResultMap">
        SELECT d.diet_id,
               d.user_id,
               d.eat_date,
               d.eat_time,
               d.meal_type,
               d.diet_img,
               d.memo,
               d.total_kcal,
               d.total_carbs,
               d.total_protein,
               d.total_fat,
               d.score,
               d.ai_analysis,
            /* 상세 정보도 같이 가져와야 매핑됨 */
               dd.detail_id,
               dd.food_code,
               dd.food_name,
               dd.amount,
               dd.kcal,
               dd.carbs,
               dd.protein,
               dd.fat
        FROM diet d
                 LEFT JOIN diet_detail dd ON d.diet_id = dd.diet_id
        WHERE d.user_id = #{userId}
          AND d.eat_date = #{date}
        ORDER BY d.eat_time ASC, d.diet_id ASC
    </select>

    <select id="selectWeeklyDiets" resultMap="DietResultMap">
        SELECT d.*, dd.*
        FROM diet d
                 LEFT JOIN diet_detail dd ON d.diet_id = dd.diet_id
        WHERE d.user_id = #{userId}
          AND d.eat_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY d.eat_date ASC, d.meal_type ASC
    </select>

    <select id="selectMonthlyDiets" resultMap="DietResultMap">
        SELECT d.*, dd.*
        FROM diet d
                 LEFT JOIN diet_detail dd ON d.diet_id = dd.diet_id
        WHERE d.user_id = #{userId}
          AND d.eat_date LIKE CONCAT(#{month}, '%')
        ORDER BY d.eat_date DESC
    </select>

    <select id="selectAllDiets" resultMap="DietResultMap">
        SELECT d.*, dd.*
        FROM diet d
                 LEFT JOIN diet_detail dd ON d.diet_id = dd.diet_id
        WHERE d.user_id = #{userId}
        ORDER BY d.eat_date DESC
    </select>

    <select id="selectDietDetail" resultMap="DietResultMap">
        SELECT d.*, dd.*
        FROM diet d
                 LEFT JOIN diet_detail dd ON d.diet_id = dd.diet_id
        WHERE d.diet_id = #{dietId}
    </select>

    <update id="updateDiet">
        UPDATE diet
        SET eat_time      = #{time},
            meal_type     = #{mealType},
            diet_img      = #{dietImg},
            memo          = #{memo},
            total_kcal    = #{totalKcal},
            total_carbs   = #{totalCarbs},
            total_protein = #{totalProtein},
            total_fat     = #{totalFat},
            score         = #{score},
            ai_analysis   = #{aiAnalysis}
        WHERE diet_id = #{dietId}
    </update>

    <delete id="deleteDiet">
        DELETE
        FROM diet
        WHERE diet_id = #{dietId}
    </delete>

    <delete id="deleteDietDetailsByDietId">
        DELETE
        FROM diet_detail
        WHERE diet_id = #{dietId}
    </delete>

    <select id="selectDietList" resultType="com.ssafy.bapai.diet.dto.DietDto">
        SELECT
        d.diet_id,
        d.memo, d.created_at,
        d.diet_img,
        d.total_kcal,
        (SELECT COUNT(*) FROM diet_likes dl WHERE dl.diet_id = d.diet_id) AS likeCount,
        (SELECT COUNT(*) FROM comments c WHERE c.diet_id = d.diet_id) AS commentCount
        FROM diet d
        WHERE 1=1
        ORDER BY
        <choose>
            <when test="sort == 'likes'">
                likeCount DESC, d.created_at DESC
            </when>
            <when test="sort == 'comments'">
                commentCount DESC, d.created_at DESC
            </when>
            <when test="sort == 'oldest'">
                d.created_at ASC
            </when>
            <otherwise>
                d.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="selectDietDetailsByDietId" resultType="com.ssafy.bapai.diet.dto.DietDetailDto">
        SELECT *
        FROM diet_detail
        WHERE diet_id = #{dietId}
    </select>

    <select id="selectDietCount" resultType="int">
        SELECT COUNT(*)
        FROM diet
    </select>

    <select id="selectDietDates" resultType="String">
        SELECT DISTINCT eat_date
        FROM diet
        WHERE user_id = #{userId}
        ORDER BY eat_date DESC
    </select>

    <select id="selectWaterInfo" resultType="map">
        SELECT water_count, water_goal
        FROM daily_log
        WHERE user_id = #{userId}
          AND date = #{date}
    </select>

    <insert id="updateWaterCountDelta">
        INSERT INTO daily_log (user_id, date, water_count, water_goal)
        VALUES (#{userId}, #{date}, GREATEST(0, 0 + #{delta}), 8) ON DUPLICATE KEY
        UPDATE
            water_count = GREATEST(0, water_count + #{delta})
    </insert>

    <insert id="updateWaterGoalDelta">
        INSERT INTO daily_log (user_id, date, water_count, water_goal)
        VALUES (#{userId}, #{date}, 0, GREATEST(0, 8 + #{delta})) ON DUPLICATE KEY
        UPDATE
            water_goal = GREATEST(0, water_goal + #{delta})
    </insert>

</mapper>