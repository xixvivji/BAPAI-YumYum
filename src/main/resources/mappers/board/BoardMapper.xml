<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.bapai.board.dao.BoardDao">

    <select id="selectBoardList" resultType="com.ssafy.bapai.board.dto.BoardDto">
        SELECT
        b.board_id,
        b.category,
        b.title,
        b.content, -- 목록에서도 내용 미리보기용
        b.user_id, -- 작성자 ID (본인글 확인용)
        b.view_count as viewCount,
        b.like_count as likeCount,
        b.dislike_count as dislikeCount,
        b.created_at as createdAt,
        b.img_url as imgUrl,
        m.name as nickname
        FROM board b
        JOIN member m ON b.user_id = m.user_id
        <where>
            <if test="category != null and category != ''">
                AND b.category = #{category}
            </if>
        </where>
        ORDER BY b.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countBoardList" resultType="long">
        SELECT COUNT(*) FROM board
        <where>
            <if test="category != null and category != ''">category = #{category}</if>
        </where>
    </select>

    <select id="selectBoardById" resultType="com.ssafy.bapai.board.dto.BoardDto">
        SELECT b.board_id,
               b.user_id,
               b.category,
               b.title,
               b.content,
               b.img_url       as imgUrl,
               b.view_count    as viewCount,
               b.like_count    as likeCount,    -- 추천수 추가
               b.dislike_count as dislikeCount, -- 비추천수 추가
               b.created_at    as createdAt,
               m.name          as nickname
        FROM board b
                 JOIN member m ON b.user_id = m.user_id
        WHERE b.board_id = #{boardId}
    </select>

    <insert id="insertBoard" parameterType="com.ssafy.bapai.board.dto.BoardDto">
        INSERT INTO board (user_id, category, title, content, img_url)
        VALUES (#{userId}, #{category}, #{title}, #{content}, #{imgUrl})
    </insert>

    <update id="updateBoard">
        UPDATE board
        SET title    = #{title},
            content  = #{content},
            category = #{category},
            img_url  = #{imgUrl}
        WHERE board_id = #{boardId}
    </update>

    <delete id="deleteBoard">
        DELETE
        FROM board
        WHERE board_id = #{boardId}
    </delete>

    <update id="updateHit">
        UPDATE board
        SET view_count = view_count + 1
        WHERE board_id = #{boardId}
    </update>

    <insert id="insertBoardReaction">
        INSERT INTO board_reaction (board_id, user_id, reaction_type)
        VALUES (#{boardId}, #{userId}, #{type})
    </insert>

    <update id="increaseBoardReactionCount">
        UPDATE board
        SET
        <if test="type == 'LIKE'">like_count = like_count + 1</if>
        <if test="type == 'DISLIKE'">dislike_count = dislike_count + 1</if>
        WHERE board_id = #{boardId}
    </update>

</mapper>