<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.bapai.team.dao.TeamDao">

    <insert id="insertTeam" useGeneratedKeys="true" keyProperty="teamId">
        INSERT INTO team (leader_id, name, description, team_img, tags, max_members, type, created_at)
        VALUES (#{leaderId}, #{name}, #{description}, #{teamImg}, #{tags}, #{maxMembers}, 'PUBLIC', NOW())
    </insert>

    <insert id="insertTeamMember">
        INSERT INTO team_member (team_id, user_id, role, joined_at)
        VALUES (#{teamId}, #{userId}, #{role}, NOW())
    </insert>

    <select id="selectTeamList" resultType="com.ssafy.bapai.team.dto.TeamDto">
        SELECT t.*, m.nickname AS leaderName,
        (SELECT COUNT(*) FROM team_member tm WHERE tm.team_id = t.team_id) AS memberCount
        FROM team t
        JOIN member m ON t.leader_id = m.user_id
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (t.name LIKE CONCAT('%', #{keyword}, '%') OR t.tags LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY t.created_at DESC
    </select>

    <select id="selectTeamDetail" resultType="com.ssafy.bapai.team.dto.TeamDto">
        SELECT t.*,
               m.nickname                                                         AS leaderName,
               (SELECT COUNT(*) FROM team_member tm WHERE tm.team_id = t.team_id) AS memberCount
        FROM team t
                 JOIN member m ON t.leader_id = m.user_id
        WHERE t.team_id = #{teamId}
    </select>

    <delete id="deleteTeamMember">
        DELETE
        FROM team_member
        WHERE team_id = #{teamId}
          AND user_id = #{userId}
    </delete>

    <select id="checkJoined" resultType="int">
        SELECT COUNT(*)
        FROM team_member
        WHERE team_id = #{teamId}
          AND user_id = #{userId}
    </select>

    <select id="countMembers" resultType="int">
        SELECT COUNT(*)
        FROM team_member
        WHERE team_id = #{teamId}
    </select>

    <select id="selectMyRole" resultType="string">
        SELECT role
        FROM team_member
        WHERE team_id = #{teamId}
          AND user_id = #{userId}
    </select>

    <update id="updateTeamLeader">
        UPDATE team
        SET leader_id = #{newLeaderId}
        WHERE team_id = #{teamId}
    </update>

    <update id="updateMemberRole">
        UPDATE team_member
        SET role = #{role}
        WHERE team_id = #{teamId}
          AND user_id = #{userId}
    </update>

    <select id="selectTeamRanking" resultType="com.ssafy.bapai.team.dto.TeamRankDto">
        SELECT m.user_id,
               m.nickname,
               IFNULL(SUM(r.score), 0) as totalScore,
               COUNT(r.report_id)      as reportCount
        FROM team_member tm
                 JOIN member m ON tm.user_id = m.user_id
                 LEFT JOIN report r ON m.user_id = r.user_id
        WHERE tm.team_id = #{teamId}
        GROUP BY m.user_id
        ORDER BY totalScore DESC
        LIMIT #{limit}
    </select>
</mapper>